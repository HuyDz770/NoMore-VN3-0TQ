local StarterGui = game:GetService("StarterGui")
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local startTime = os.clock()

-- --- CẤU HÌNH ---
local keywords = {
    "require", "getfenv", "setfenv", "loadstring", 
    "HttpService", "TeleportService", "LALOL", "Backdoor", 
    "RoSync", "virus", "Infect"
}

local foundBackdoor = false
local foundPath = "nil"
local foundSnippet = "nil"

-- --- HÀM TẠO GUI DỰ PHÒNG (NẾU NOTIFICATION LỖI) ---
local function createBackupUI(title, text)
    local sg = Instance.new("ScreenGui")
    sg.Name = "BackdoorScanResult"
    
    -- Ưu tiên cho vào CoreGui để không bị game xóa, nếu không thì vào PlayerGui
    pcall(function() sg.Parent = CoreGui end)
    if not sg.Parent then sg.Parent = Players.LocalPlayer:WaitForChild("PlayerGui") end

    local frame = Instance.new("Frame", sg)
    frame.Size = UDim2.new(0, 400, 0, 200)
    frame.Position = UDim2.new(0.5, -200, 0.3, 0)
    frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    frame.BorderSizePixel = 0
    
    local corner = Instance.new("UICorner", frame)
    corner.CornerRadius = UDim.new(0, 8)

    local titleLbl = Instance.new("TextLabel", frame)
    titleLbl.Size = UDim2.new(1, 0, 0, 40)
    titleLbl.BackgroundTransparency = 1
    titleLbl.Text = title
    titleLbl.TextColor3 = Color3.fromRGB(255, 50, 50)
    titleLbl.TextSize = 24
    titleLbl.Font = Enum.Font.GothamBold

    local contentLbl = Instance.new("TextLabel", frame)
    contentLbl.Size = UDim2.new(1, -20, 1, -50)
    contentLbl.Position = UDim2.new(0, 10, 0, 40)
    contentLbl.BackgroundTransparency = 1
    contentLbl.Text = text
    contentLbl.TextColor3 = Color3.fromRGB(255, 255, 255)
    contentLbl.TextWrapped = true
    contentLbl.TextXAlignment = Enum.TextXAlignment.Left
    contentLbl.TextYAlignment = Enum.TextYAlignment.Top
    contentLbl.TextSize = 14
    contentLbl.Font = Enum.Font.Code

    -- Tự xóa sau 10 giây
    task.delay(10, function() sg:Destroy() end)
end

-- --- HÀM QUÉT ---
local function safeCheck(scriptObj)
    if not decompile then return false, "No Decompiler" end
    -- Bỏ qua CoreGui để tránh crash
    if scriptObj:IsDescendantOf(CoreGui) then return false, nil end

    local success, code = pcall(function() return decompile(scriptObj) end)

    if success and type(code) == "string" and code ~= "" then
        for line in code:gmatch("[^\r\n]+") do
            for _, k in ipairs(keywords) do
                if string.find(line, k) then
                    -- Làm sạch code
                    line = line:gsub("^%s+", ""):gsub("%s+$", "")
                    if #line > 60 then line = string.sub(line, 1, 57) .. "..." end
                    return true, line
                end
            end
        end
    end
    return false, nil
end

-- --- THỰC THI QUÉT ---
warn("--- ĐANG QUÉT BACKDOOR... ---")

local items = game:GetDescendants()
for i, obj in ipairs(items) do
    if obj:IsA("LocalScript") or obj:IsA("ModuleScript") then
        local isSus, snippet = safeCheck(obj)
        if isSus then
            foundBackdoor = true
            foundPath = obj:GetFullName()
            foundSnippet = snippet
            break
        end
    end
    -- Giảm lag (cứ 200 object thì nghỉ 1 nhịp)
    if i % 200 == 0 then task.wait() end
end

local endTime = os.clock()
local totalTime = endTime - startTime

-- --- CHUẨN BỊ NỘI DUNG ---
local titleText = foundBackdoor and "⚠️ Backdoor FOUND!" or "✅ Backdoor not found"
local contentText = string.format(
    "Time: %.11f ( second )\nPath: %s\nCode: %s",
    totalTime,
    foundPath or "nil",
    foundSnippet or "nil"
)

print("\n" .. titleText)
print(contentText)

-- --- GỬI THÔNG BÁO (THỬ NHIỀU CÁCH) ---
task.spawn(function()
    local success = pcall(function()
        StarterGui:SetCore("SendNotification", {
            Title = titleText,
            Text = contentText,
            Duration = 10,
        })
    end)

    if not success then
        warn("SendNotification thất bại! Đang chuyển sang Backup UI...")
        createBackupUI(titleText, contentText)
    end
end)
